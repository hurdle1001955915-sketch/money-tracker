# Phase5: 集計/グラフ/カレンダー 監査

## 実行日時

- 実行日: 2026-01-23
- 目的: 集計の正確性、カレンダー形式の整合性、およびグラフ表示の信頼性を監査する。

---

## 1. 集計ロジックの定義と現状

### 1.1 集計対象データの定義

- **集計対象**: `Transaction` モデルのうち、`isDeleted` が `false` かつ `type` が `.income` または `.expense` のもの。
- **除外**:
  - `type == .transfer` (振替) は、収支計算（`monthlyIncome`, `monthlyExpense`）からは**完全に除外**される。
  - 削除済みデータ（`isDeleted`）も除外（ただし現状の実装では物理削除されるためメモリ上に存在しない）。
- **資産残高 (`AccountStore`)**:
  - `activeAccounts` ベースで計算。
  - 振替 (`.transfer`) はここで初めて計算対象となり、出金元から減算/入金先へ加算される。

### 1.2 期間の定義と境界

- **基準**: `Date` 型（絶対時刻）を保持し、**ユーザーの端末設定（`Calendar.current`）** に基づいて年/月/日を判定。
- **タイムゾーン影響**:
  - アプリ内でタイムゾーンを固定していないため、海外移動等で端末のタイムゾーンが変わると、取引の「日付」や「所属する月」が変化する（例: 1日朝の取引が前月末扱いになる）。
- **締め日**: 設定機能なし（常に1日〜末日）。

### 1.3 カテゴリ別集計の根拠

- **ID一致**: `Transaction.categoryId` と `Category.id` の一致で集計。
- **未分類/削除済みカテゴリ**:
  - **現状の欠陥**: `GraphView` において、マスタ(`categories`)に存在しないIDを持つ取引（カテゴリ削除後など）は、**内訳グラフ（円グラフ等）には表示されないが、合計金額には含まれる**。
  - これにより「円グラフの合計 ≠ 表示されている合計金額」という不整合が発生する。

### 1.4 カレンダー表示のロジック

- **グリッド**: 常に6週間（42マス）固定表示。
- **データ取得**: `DataStore.transactionsForMonth` で当該月の取引を一括取得し、`Calendar.current.component(.day)` で日ごとに振り分け。

### 1.5 グラフ更新のトリガ

- **State管理**: `GraphView` は `DataStore` を `@EnvironmentObject` として監視。
- **反映タイミング**: `DataStore` 内の `transactions` 配列が更新（追加/編集/削除）されると即座に再描画される。

---

## 2. 誤計算・不整合のリスク（10選）

| ID | リスクレベル | 現象・条件 | 根拠・原因 |
|---|---|---|---|
| **AN-001** | **High** | 円グラフの合計と内訳の不一致 | `GraphView.swift:222`<br>削除されたカテゴリIDを持つ取引が、`total` には含まれるが `categoryData` ループ（マスタ依存）からは漏れる。 |
| **AN-002** | **Medium** | タイムゾーン変更による月ズレ | `DataStore.swift:416`<br>`Calendar.current` 利用のため、月初の取引がタイムゾーン変更で前月扱いになり、過去の収支レポートが変わる。 |
| **AN-003** | **Medium** | 残高計算のパフォーマンス劣化 | `AccountStore.swift:113`<br>`totalBalance` 計算時に、全口座 × 全取引の二重ループが走るため、データ量増加と共に計算量が増大する。 |
| **AN-004** | **Low** | 振替の循環参照リスク | 振替は `Transaction` 2レコードで表現されるが、片方だけ削除された場合や整合性が崩れた場合、資産残が合わなくなる（現状はペア削除ロジックあり）。 |
| **AN-005** | **Low** | 固定費の二重計上（稀） | `FixedCost.swift`<br>`lastProcessedMonth` が "YYYY-MM" 文字列管理のため、カレンダー体系（和暦など）が変わるとフォーマットが崩れる可能性（現状は西暦前提の実装に見えるがリスクあり）。 |
| **AN-006** | **Low** | 前月繰越の扱い | `CalendarView.swift:33`<br>`showPreviousBalance` ON時、UI上で収入に繰越分が加算される実装になっており、純粋な「当月収入」と混同しやすい。 |
| **AN-007** | **Low** | ストリーク計算の不正確さ | `DataStore.swift:440`<br>`calculateStreak` が単純な日付集合の連続性チェックのみで、タイムゾーン境界での「同日扱い」判定が不安定な可能性がある。 |
| **AN-008** | **Medium** | 未分類データのグラフ除外 | `GraphView` は「存在するカテゴリ」のみをループするため、`categoryId: nil`（未分類）の取引が円グラフから消失する。 |
| **AN-009** | **Low** | 数値オーバーフロー | `Int` 型使用。日本円なら通常問題ないが、インフレ通貨や誤入力で900京を超えるとクラッシュまたは不正値になる。 |
| **AN-010** | **Low** | 週の始まり設定の不整合 | カレンダーは設定(`settings.weekStartDay`)に従うが、集計（週別グラフ等がある場合）で整合性が取れていない場合がある（現状は月次集計メイン）。 |

---

## 3. 推奨テスト・修正案

### 3.1 必須修正 (AN-001, AN-008)

**グラフ内訳に「未分類/その他」セクションを強制追加する**

- `GraphView` のパイチャート生成ロジックにおいて、`total` と `sum(categories)` の差分を計算し、差額があれば「不明・未分類」としてチャートに追加する処理を入れる。

### 3.2 パフォーマンス改善 (AN-003)

**残高計算のキャッシュ化またはクエリ最適化**

- `AccountStore` 側で各口座の「現在残高」をプロパティとして持ち、取引追加/削除時のみ差分更新する、あるいは計算ロジックを `reduce` 1回で全口座分計算するように書き換える。

### 3.3 データ保全

**カテゴリ削除時の依存解決**

- カテゴリ削除時、該当する取引の `categoryId` を `nil` (未分類) または「その他」カテゴリに付け替える処理を `DataStore.deleteCategory` で徹底する（現状の実装も確認が必要）。

### 3.4 テスト計画

- **TestCase 1**: カテゴリIDが `nil` の取引を含む状態でグラフを描画し、合計金額と円グラフの比率が合うか確認。
- **TestCase 2**: 存在しないUUIDを `categoryId` に持つ取引を作成し、グラフでの挙動を確認。
- **TestCase 3**: タイムゾーンをJST -> UTCに変更し、1日午前8時の取引が前月に移動することを確認。
- **TestCase 4**: 取引件数10,000件状態で残高計算の速度を計測。
- **TestCase 5**: 振替取引の片方だけを（不正に）削除した状態で残高整合性を確認。
