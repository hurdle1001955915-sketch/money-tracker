# Phase8: 統合ロードマップ（修正計画＋追加機能）

## 実行日時

- 実行日: 2026-01-23
- 目的: Phase0〜7の調査結果を統合し、止血から安定化、そして機能拡張へと至る実装計画を確定する。

---

## 1. 重要問題（Critical Issues）

これらはユーザーの資産（データ）を脅かす、またはアプリが使用不能になるリスクであり、**機能追加よりも優先して修正されなければならない**。

| ID | レベル | 問題 | 参照 |
|---|---|---|---|
| **CR-001** | **Blocker** | **SwiftData保存失敗時の強制クラッシュ**<br>`KakeiboApp.swift` で `try!` や `fatalError` を使用しており、DB初期化に失敗するとアプリが起動しなくなる。 | [Phase1: Build/Run](../Audit/Phase1_BuildRun.md) |
| **CR-002** | **Critical** | **全データオンメモリ管理によるデータ消失リスク**<br>`DataStore` が全データをメモリ上の配列で管理し、保存時のみJSONへ書き出す構造。クラッシュ時に未保存データが全損する。 | [Phase2: Persistence](../Audit/Phase2_Persistence.md) |
| **CR-003** | **Major** | **カテゴリIDマイグレーションの脆弱性**<br>文字列揺らぎ（全角半角など）の正規化を行わずマイグレーションするため、過去データが大量に「未分類/不明」になるリスクがある。 | [Phase6: Category/Migration](../Audit/Phase6_CategoryRulesMigration.md) |
| **CR-004** | **Major** | **個人情報ログの平文出力**<br>リリースビルドでも金額やカテゴリ名を含むデバッグログが出力されており、プライバシー侵害のリスクがある。 | [Phase7: Quality](../Audit/Phase7_Quality.md) |
| **CR-005** | **Major** | **CSVインポート機能の重複と混乱**<br>`CSVImportView` (旧) と `CSVImportWizardView` (新) が混在し、設定画面からも複数の導線がある。保守コスト倍増かつユーザーの混乱を招く。 | [Phase3: CSV](../Audit/Phase3_CSVImport.md) |

---

## 2. 修正フェーズ計画 (Refactoring Phases)

### Phase R0: 止血・安定化 (Stability First)

**目的**: アプリが落ちない、データが消えない状態にする。

- [ ] **R0-1 (CR-001)**: `KakeiboApp.swift` の `fatalError` を排除し、インメモリコンテナへのフォールバックを実装する。
- [ ] **R0-2 (CR-002)**: データ変更直後に必ず `save()` を呼ぶ、またはSwiftDataの自動保存機構 (`autosaveEnabled`) に完全移行する準備をする。
- [ ] **R0-3 (CR-004)**: `Diagnostics` クラスに `#if DEBUG` ガードを追加し、リリースビルドでのログ出力を停止する。

**完了条件 (DoD)**:

- DB破壊状態でもアプリが起動し、「データ読み込みエラー」等のダイアログが出る。
- 取引入力直後にアプリをキルしてもデータが維持される。

### Phase R1: CSVインポート統合 (Unified CSV Import)

**目的**: 複雑化したインポート機能を一本化し、保守性とUXを向上させる。

- [ ] **R1-1 (CR-005)**: `CSVImportWizardView`（ウィザード形式）を正とし、`CSVImportView`（旧・一枚ペラ）を削除またはウィザードへのラッパーに変更する。
- [ ] **R1-2**: `UnclassifiedItemsView` と `UnclassifiedReviewView` の重複を整理し、ウィザード完了後のフローに統合する。
- [ ] **R1-3**: 自動判定ロジック (`CSVFormatDetector`) の誤判定時の手動修正フローを確立する。

**完了条件 (DoD)**:

- 設定画面の「データ管理」セクションから、単一の「CSVインポート」ボタンでウィザードが起動する。
- 古いViewファイルが削除されている。

### Phase R2: 機能不全の解消 (Feature Fixes)

**目的**: 「あるはずなのに動かない」「使いにくい」機能を直す。

- [ ] **R2-1 (Search)**: `TransactionSearchView` で `TransactionInputView` が正しく連携するようにし、検索結果からの編集・削除を可能にする。
- [ ] **R2-2 (Category)**: `RulesManagementView` を削除し、`ClassificationRulesView` に一本化する。
- [ ] **R2-3 (Migration)**: `DataMigration` に `TextNormalizer` を導入し、カテゴリ名の揺らぎ（全角/半角/スペース）を吸収してID紐付け率を向上させる。

**完了条件 (DoD)**:

- 検索画面から明細を修正して戻った際、リストが更新されている。
- マイグレーション実行後、"Amazon" と "Ａｍａｚｏｎ" が同一IDに統合される。

### Phase R3: 品質の向上 (Performance & Test)

**目的**: データ量が増えてもサクサク動くようにする。

- [ ] **R3-1 (Perf)**: `AccountStore` の残高計算ロジックを見直し、O(N) から差分計算に変更する。
- [ ] **R3-2 (Test)**: `CSVImportTests` などを現在のコードベースに合わせて修正し、全部パスするようにする。
- [ ] **R3-3 (UI)**: グラフ再描画の抑制（`Equatable` Viewの導入）。

---

## 3. 追加機能案 TOP10 (New Features)

これらは修正フェーズ完了後に着手すべき機能である。

| 順位 | 機能名 | 価値 (Value) | 難易度 (Cost) | 概要 |
|---|---|---|---|---|
| 1 | **予算と実績の予実管理強化** | High | Medium | 現在の単純な予算表示に加え、日割り予算 (`残り予算 / 残り日数`) やペース配分アラートを表示する。 |
| 2 | **固定費の自動反映** | High | High | 月初などに固定費テンプレートから自動的に実績データを作成する（現在は手動？要確認）。または「予定」としてカレンダーに表示。 |
| 3 | **複数口座の資産推移グラフ** | High | Medium | 口座ごとの残高推移を積み上げ面グラフで表示し、総資産の増減を可視化する。 |
| 4 | **レシートスキャン強化** | Medium | High | 現在のOCR精度を改善、またはVision Frameworkの新しいAPIを使用して品目ごとの分割入力をサポートする。 |
| 5 | **カレンダーのUI改善** | Medium | Low | カレンダーの日付セルに、その日の「支出合計」だけでなく「収入」や「収支」を切り替えて表示できるようにする。 |
| 6 | **タグ管理機能** | Medium | Low | カテゴリとは別に「旅行」「交際費」などのタグを付けられるようにし、横断的な集計を可能にする。 |
| 7 | **Excelエクスポート** | Medium | Medium | CSVだけでなく、装飾済みのExcel (.xlsx) 形式でレポートを出力する。 |
| 8 | **ウィジェットの多機能化** | Low | Medium | 現在の「今日/今月の支出」に加え、「予算残高」や「入力ショートカット」などのバリエーションを増やす。 |
| 9 | **ダークモード完全対応** | Low | Low | 一部ハードコードされた色（黒文字など）を見直し、システムテーマに完全追従させる。 |
| 10 | **iPad対応 / Mac対応** | Low | High | サイドバーレイアウトなどを導入し、大画面デバイスに最適化する。 |

---

## 4. 承認プロセスへの質問事項 (Questions)

ロードマップ確定にあたり、以下の点の確認が必要です：

1. **ウィザードへの一本化**: 旧来のシンプルインポート画面（`CSVImportView`）は廃止してよいか？（ウィザードの方が手数は多いが確実）
2. **生体認証のフォールバック**: アプリ内PINコード実装はコストが高いため、当面は「OSパスコードへのフォールバック」仕様で許容できるか？
3. **オンメモリ管理の限界**: データ件数が数万件に達するユーザーを想定するか？（想定する場合、Phase R3での根本的なDB移行が必要）
